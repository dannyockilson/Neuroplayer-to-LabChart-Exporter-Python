#!/usr/bin/env bash
# Git pre-commit hook to run code quality checks
# This runs black, isort, and mypy on all Python files

set -e

# Change to repo root directory
cd "$(git rev-parse --show-toplevel)"

echo "Running pre-commit checks..."

# Get list of staged Python files
PYTHON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

if [ -z "$PYTHON_FILES" ]; then
    echo "No Python files to check"
    exit 0
fi

echo "Checking Python files:"
echo "$PYTHON_FILES" | sed 's/^/  - /'
echo ""

# Run black with proper quoting
echo "Running black..."
echo "$PYTHON_FILES" | xargs python -m black
if [ $? -ne 0 ]; then
    echo "❌ Black formatting failed"
    exit 1
fi

# Run isort with proper quoting
echo "Running isort..."
echo "$PYTHON_FILES" | xargs python -m isort
if [ $? -ne 0 ]; then
    echo "❌ isort failed"
    exit 1
fi

# Run mypy with proper quoting
echo "Running mypy..."
echo "$PYTHON_FILES" | xargs python -m mypy --ignore-missing-imports
if [ $? -ne 0 ]; then
    echo "❌ mypy type checking failed"
    exit 1
fi

# Re-add files that were formatted
echo "Re-staging formatted files..."
echo "$PYTHON_FILES" | xargs git add

echo "✅ All pre-commit checks passed"
exit 0
